<html>
  <head>
    <script src="http://code.createjs.com/createjs-2014.12.12.min.js"></script>
    <script>

    var cellWidth = 6;
    var cellHeight = 6;

    var cellArray = [];
    var colorArray = ["red","blue"];

    var CONVERSION_RED = 0.5;
    var CONVERSION_BLUE = 0.5;

    var AGGRESSION_RED = 0;
    var AGGRESSION_BLUE = 0;

    var REPRODUCTION_RED = 2;
    var REPRODUCTION_BLUE = 2;

    var AGGRESSION_INCREMENT = 2;

    var AGGRESSION_SCALE_RED = 5;
    var AGGRESSION_SCALE_BLUE = 5;

    var BLAST_THRESHOLD_RED = .25;
    var BLAST_THRESHOLD_BLUE = .25;

    var conversionArray = [CONVERSION_RED,CONVERSION_BLUE];
    var aggressionArray = [0,0];
    var reproductionArray = [4,2]; 
    var stage;
    var count =0;

    var scale = 2;

    var rows;
    var cols;
    var totalConversionArray = [0,0,0]; //index is for type
    var totalCountArray = [0,0,0];

    var aggressionIncrement = 2;
    var aggressionScale = [0,5,5];
  

    var CONVERSION_FACTOR = 10;
    var expiryTime = 30;
    var blastThresholdArray = [0,0.25,0.25];

    var selectedType = 0;
      
    function init() {
        stage = new createjs.Stage("myCanvas");
        rows = stage.canvas.height/(cellHeight*scale);
        cols = (stage.canvas.width - 200)/(cellWidth*scale);

        createButton();

        for (var i = 0;i < rows; ++i) {
          var tempArray = [];
          for (var j = 0;j < cols; ++j) {
            var cell ={};
            
            cell.rHits = 0;
            cell.bHits = 0;
            cell.spawnTime = 0;
            tempArray.push(cell);

            // if ((i == Math.floor(rows/4)) && (j == Math.floor(cols/4))) {
              if ((i == 4) && (j == 4)) {
              circle = drawCircle((j+.5)*cellWidth,
                     (i+.5)*cellHeight,
                     cellWidth,"red");
              cell.type = 1;
            }
            // else if ((i == Math.floor(3*rows/4))&& (j == Math.floor(3*cols/4))) {
              else if ((i == rows - 4) && (j == cols - 4)) {
              circle = drawCircle((j+.5)*cellWidth,
                     (i+.5)*cellHeight,
                     cellWidth,"blue");
              cell.type = 2;
            }  
            else {
              circle = drawCircle((j+.5)*cellWidth,
                     (i+.5)*cellHeight,
                     cellWidth,"blue");
              circle.graphics.clear();
              cell.type = 0;
            }
            stage.addChild(circle);
            cell.circle = circle;
          }
          cellArray.push(tempArray);

        }

        createjs.Ticker.framerate = 10;
        createjs.Ticker.addEventListener("tick", handleTick)

        stage.update();
    }

    function handleTick() {
      
      var typeArray = [];
      for (var i = 0;i < rows; ++i) {
      
        for (var j = 0;j < cols; ++j) {
          var cell = cellArray[i][j];
          typeArray.push(applyRule(cell,i,j));
      
        }
        
      }

      totalCountArray[0] = 0;
      totalCountArray[1] = 0;
      totalCountArray[2] = 0;

      for(var i = 0;i < cellArray.length;i++){
        for(var j =0;j < cellArray[i].length;j++){
          var newType = typeArray[i*cellArray.length + j];
          var cell = cellArray[i][j];
          // if (cell.type == newType) {
            // OLd age check
          //   if ((cell.spawnTime > expiryTime) && (newType != 0)) {
          //     newType = 0;
          //     cell.spawnTime = 0;
          //     console.log("spawntime");
          //   }
          // }
          cell.type = newType;
           
          changeCircle(cell.circle,cell.type);    
          totalCountArray[cell.type]++;
          cell.spawnTime++;
        }
      }
      
      updateRules();

      updateCoefficients();

      stage.update();      

    }


    function updateCoefficients() {
      
      var delta = 100;

      conversionArray[0] += (CONVERSION_RED - conversionArray[0])/delta;
      conversionArray[1] += (CONVERSION_BLUE - conversionArray[1])/delta;

      reproductionArray[0] += (REPRODUCTION_RED - reproductionArray[0])/delta;
      reproductionArray[1] -= (REPRODUCTION_BLUE - reproductionArray[1])/delta;

      aggressionScale[1] += (AGGRESSION_SCALE_BLUE - aggressionScale[1])/delta;
      aggressionScale[2] += (AGGRESSION_SCALE_BLUE - aggressionScale[2])/delta;
      
      aggressionIncrement += (AGGRESSION_INCREMENT - aggressionIncrement)/delta;

      blastThresholdArray[1] = (BLAST_THRESHOLD_RED - blastThresholdArray[1])/delta;
      blastThresholdArray[2] = (BLAST_THRESHOLD_BLUE - blastThresholdArray[2])/delta;


    }

    function updateRules() {
      
      for (var i = 0; i < 2; ++i) {
        if (aggressionArray[i] > 0) {
          aggressionArray[i] = 0;
        }

        if (totalConversionArray[i] > blastThresholdArray[i]*totalCountArray[i]) {
          aggressionArray[i] += aggresionIncrement;
          totalConversionArray[i] = 0;
        }
      }

    }

    // Type - 0 = empty, 1 = red, 2 = blue
    function changeCircle(circle, newType) {
      circle.graphics.clear();

      if (newType == 0) {
        return;
      }

      var myGraphics = new createjs.Graphics();

      var color = colorArray[newType-1];
      myGraphics.beginFill(color).drawCircle(circle.x,circle.y,circle.radius);
      circle.graphics = myGraphics;
    }

    function drawCircle(x,y,radius,color) {
      
       var g = new createjs.Graphics();
       g.beginFill(color);       
       g.drawCircle(x,y,radius);

       var circle = new createjs.Shape();
       circle.graphics = g;
       circle.x = x;
       circle.y = y;
       circle.radius = radius;       
       return circle;
    }

  function getDistancesFromNeighbours(inputType,i,j) {
      var distance = 1;

      var count = 0;

    for (var x = -1*distance; x <= distance; ++x) {
        for (var y = -1*distance; y <= distance; ++y) { 
        
        if (((i + y < 0) || (i + y > cellArray.length - 1)) ||
            ((j + x < 0) || (j + x > cellArray[0].length - 1))) {
              continue;
        }
        if (cellArray[i + y][j + x].type == inputType) {
            ++count;     
        }
      }
    }

    var aggressionCount = 0;
  
    distance = aggressionScale[cellArray[i][j].type];

    for (var x = -1*distance; x <= distance; ++x) {
        for (var y = -1*distance; y <= distance; ++y) {  
        
        if (((i + y < 0) || (i + y > cellArray.length - 1)) ||
            ((j + x < 0) || (j + x > cellArray[0].length - 1))) {
              continue;
        }
        if (cellArray[i + y][j + x].type == inputType) {
          
          aggressionCount++;     
        }
      }
    }

    var retObj = {};
    retObj.count = count;
    retObj.aggressionCount = aggressionCount;

    return retObj;
  }

    function applyRule(cell,i,j) {
      
      if ((i == 0) || (j == 0) || 
      (i==cellArray.length - 1) || 
      ( j == cellArray[0].length -  1)) {
        return 0;
      }
      
      
      var distancesRed = getDistancesFromNeighbours(1,i,j);
      var distancesBlue = getDistancesFromNeighbours(2,i,j);

      var redCount = distancesRed.count;
      var redCountAggression = distancesRed.aggressionCount;

      var blueCount = distancesBlue.count;
      var blueCountAggression = distancesBlue.aggressionCount;

      var newCellType = cell.type;
      if (cell.type == 0) {
        if (((redCount >= 1) && (redCount <= 3))) {

          if (cell.rHits > reproductionArray[0]) {
            var randomVal = Math.random(1);
            newCellType = Math.floor(randomVal + 0.5);  
          } else {
            cell.rHits++;
          }
        } 
        if((blueCount >=1) && (blueCount <= 3)) {

          if (cell.bHits > reproductionArray[1]) {
            var randomVal = Math.random(1);
            newCellType = Math.floor(randomVal + 0.5) * 2;  
            // cell.bHits = -20;
          } else {
            cell.bHits++;
          }
        }
      } 
      else if (cell.type == 1) {
       if(blueCountAggression != 0){ 
          if(redCountAggression * aggressionArray[0] < blueCountAggression * aggressionArray[1]){
            newCellType = 0;
          }else
           if ((blueCount != 0) && (blueCount*conversionArray[1] > redCount*conversionArray[0])) {
            if (cell.bHits > conversionArray[0]*CONVERSION_FACTOR) {
              newCellType = 2;
              totalConversionArray[0]++;
              cell.bHits=0; 
            } else {
              cell.bHits++;
            }
          }
        } 
      } else if (cell.type == 2) {
        if(redCountAggression != 0){
          if(redCountAggression * aggressionArray[0] > blueCountAggression * aggressionArray[1]){
            newCellType = 0;
          }else
          if ((redCount != 0) && (redCount*conversionArray[0] > blueCount*conversionArray[1])) {
              if (cell.rHits > conversionArray[1]*CONVERSION_FACTOR) {
                newCellType = 1;
                totalConversionArray[1]++;
                cell.rHits = 0
                } else {
                  cell.rHits++;
                }
          }
        }
      }
      return newCellType;
    }


    // Button
    function createButton() {
      
      var button = new createjs.Shape();
      button.graphics.beginFill("red").drawRoundRect(0, 0, 40,40,5);
      //Set position of Shape instance.
      button.x = 650; button.y = 300;
      //Add Shape instance to stage display list.
      stage.addChild(button);

      button.addEventListener("click", handleClickFoodDec);

      button = new createjs.Shape();
      button.graphics.beginFill("red").drawRoundRect(0, 0, 40,40,5);
      //Set position of Shape instance.
      button.x = 650; button.y = 150;
      //Add Shape instance to stage display list.
      stage.addChild(button);

      button.addEventListener("click", handleClickFoodInc);

      button = new createjs.Shape();
      button.graphics.beginFill("green").drawRoundRect(0, 0, 40,40,5);
      //Set position of Shape instance.
      button.x = 700; button.y = 150;
      //Add Shape instance to stage display list.
      stage.addChild(button);

      button.addEventListener("click", handleClickMilitaryInc);

      button = new createjs.Shape();
      button.graphics.beginFill("green").drawRoundRect(0, 0, 40,40,5);
      //Set position of Shape instance.
      button.x = 700; button.y = 300;
      //Add Shape instance to stage display list.
      stage.addChild(button);

      button.addEventListener("click", handleClickMilitaryDec);

    }

    function handleClickFoodInc(event){
    
      conversionArray[0] += .2;
      conversionArray[1] -= .2;

      reproductionArray[0] -= 2;
      reproductionArray[1] += 2;

    }

    function handleClickFoodDec(event){
      
      conversionArray[0] -= .2;
      conversionArray[1] += .2;

      reproductionArray[0] += 2;
      reproductionArray[1] -= 2;

    }

    function handleClickMilitaryInc(){
      aggressionScale[2]+=2;
      aggressionIncrement+=2;

      blastThresholdArray[1] = max(0,blastThresholdArray[1] - .1);
    }
    function handleClickMilitaryDec() {
      aggressionScale[2]-=2;
      aggressionIncrement-=2;

      blastThresholdArray[1] = min(1,blastThresholdArray[1] + .1);
    }

    </script>
  </head>
  <body onload="init();">
    <canvas id="myCanvas" width="800" height="600"></canvas>
  </body>
</html>